/*! tink-helper-format-angular v1.1.4 */
"use strict";!function(module){try{module=angular.module("tink.formathelper")}catch(e){module=angular.module("tink.formathelper",["tink.datehelper","tink.safeApply"])}module.controller("tinkFormatController",["$scope",function($scope){function loadAll(){config=self.config,format=config.format,placeholder=config.placeholder,self.setValue(placeholder),newVa=placeholder,self.element.bind("keydown",function(event){return keyDowned=self.getValue(),(91===event.which||92===event.which||93===event.which)&&(controlKey=1),(event.ctrlKey||event.metaKey)&&88===event.which?(setTimeout(function(){self.setValue(placeholder)},1),!0):8===event.which?(handleBackspace(),!1):46===event.which?(handleDelete(),!1):void 0}),self.element.bind("keyup",function(event){(91===event.which||92===event.which||93===event.which)&&(controlKey=0)}),self.element.bind("mousedown",function(){return $scope.isDisabled===!0?!1:void setTimeout(function(){placeholder===newVa&&setCursor(0)},1)}),self.element.bind("focus",function(){setTimeout(function(){var pos=firstCh();pos!==newVa.length&&setCursor(firstCh())},20)}),self.element.bind("paste",function(e){var cursor=getCaretSelection();e.preventDefault();var text=(e.originalEvent||e).clipboardData.getData("text/plain");window.document.execCommand("insertText",!1,text),self.setValue(keyDowned);for(var i=0;i<text.length;i++)handleInput(text[i],cursor),cursor++}),self.element.keypress(function(event){if(!controlKey){var key=String.fromCharCode(event.which);return handleInput(key),!1}}),self.form}function handleInput(key,cur){var cursor,selection;if(cur?(cursor=cur.start,selection=cur.end):(cursor=getCaretSelection().start,selection=getCaretSelection().end),cursor>-1&&cursor<format.length)if("0"===format[cursor])charIs(key,"0")?(cursor!==selection&&(newVa=newVa.replaceRange(cursor,selection,placeholder)),newVa=newVa.replaceAt(cursor,key),cursor+=1):newVa=newVa.replaceRange(cursor,selection,placeholder);else{if(charIs(key,"0"))return void handleInput(key,{start:cursor+1,end:selection+1});cursor+=1}deleteVal=-1,self.setValue(newVa,cursor)}function handleBackspace(){var cursor=getCaretSelection();cursor.start===cursor.end&&cursor.start>0?(newVa=newVa.replaceAt(cursor.start-1,placeholder[cursor.start-1]),self.setValue(newVa,cursor.start-1)):(newVa=newVa.replaceRange(cursor.start,cursor.end,placeholder),self.setValue(newVa,cursor.start))}function handleDelete(){var cursor=getCaretSelection();if(cursor.start===cursor.end){for(var pos=cursor.start;placeholder[cursor.start]===newVa[cursor.start]&&cursor.start<placeholder.length-1;)cursor.start++;newVa=newVa.replaceAt(cursor.start,placeholder[cursor.start]),self.setValue(newVa,pos)}else newVa=newVa.replaceRange(cursor.start,cursor.end,placeholder),self.setValue(newVa,cursor.start)}function firstCh(){for(var i=0;i<newVa.length;i++){if(newVa.length!==format.length)return 0;if("0"===format[i]&&!(newVa[i]>-1&&newVa[i]<10))return i}return newVa.length}function valueToHtml(value){for(var html="",plHtml='<span class="placeholder">',plEHtml="</span>",open=0,i=0;i<placeholder.length;i++)placeholder[i]===value[i]?0===open?(html+=plHtml+value[i],open=1):1===open&&(html+=value[i]):1===open?(html+=plEHtml+value[i],open=0):html+=value[i];return 1===open&&(html+=plEHtml),html}function charIs(char,base){return char=char.trim(),"0"===base&&""!==char&&char>-1&&10>char?!0:!1}function getCaretSelection(){var caretOffset=0,element=self.element.get(0);element.focus();var sel,startOffset,doc=element.ownerDocument||element.document,win=doc.defaultView||doc.parentWindow;if("undefined"!=typeof win.getSelection){if(sel=win.getSelection(),sel.rangeCount>0){var range=win.getSelection().getRangeAt(0),preCaretRange=range.cloneRange();preCaretRange.selectNodeContents(element),preCaretRange.setEnd(range.endContainer,range.endOffset),caretOffset=preCaretRange.toString().length,startOffset=caretOffset-window.getSelection().toString().length}}else if((sel=doc.selection)&&"Control"!==sel.type){var textRange=sel.createRange(),preCaretTextRange=doc.body.createTextRange();preCaretTextRange.moveToElementText(element),preCaretTextRange.setEndPoint("EndToEnd",textRange),caretOffset=preCaretTextRange.text.length,startOffset=caretOffset-document.selection.createRange().text.length}return{start:startOffset,end:caretOffset}}function setCursor(cur){for(var el=self.element[0],range=document.createRange(),sel=window.getSelection(),lengths=0,chosenChild=0,i=0;i<self.element[0].childNodes.length;i++){var node=self.element[0].childNodes[i];"#text"===node.nodeName?(lengths+=node.length,chosenChild=node):(lengths+=node.childNodes[0].length,chosenChild=node.childNodes[0]),lengths>=cur&&(cur-=lengths-chosenChild.length,i=9999)}range.setStart(chosenChild,cur),range.collapse(!0),sel.removeAllRanges(),sel.addRange(range),el.focus()}var config,format,placeholder,newVa,self=this,deleteVal=-1,controlKey=0,keyDowned="";self.init=function(element,config,form,ngControl){self.element=element,self.config=config,self.form=form,self.ngControl=ngControl,loadAll()},String.prototype.replaceAt=function(index,character){return this.substr(0,index)+character+this.substr(index+character.length)},String.prototype.replaceRange=function(start,stop,value){return this.substr(0,start)+value.substr(start,stop-start)+this.substr(stop)},self.setValue=function(value,cur,force){newVa=force?value:value&&value.length!==placeholder.length?placeholder:value?value:placeholder,"DIV"===self.element[0].nodeName?(self.element.html(valueToHtml(newVa)),self.element.trigger("valueChanged",[newVa])):self.element.val(newVa),cur&&cur>-1&&cur<=format.length&&setCursor(cur)},self.getValue=function(){return newVa}}])}(),function(module){try{module=angular.module("tink.formathelper")}catch(e){module=angular.module("tink.formathelper",["tink.datehelper","tink.safeApply"])}module.directive("tinkFormatInput",["dateCalculator","$window","safeApply",function(dateCalculator,$window,safeApply){return{restrict:"EA",replace:!0,priority:99,controller:"tinkFormatController",controllerAs:"ctrl",scope:{minDate:"=?",maxDate:"=?",isDisabled:"="},require:["tinkFormatInput","ngModel","?^form"],template:function(){var isNative=/(ip(a|o)d|iphone|android)/gi.test($window.navigator.userAgent),isTouch="createTouch"in $window.document&&isNative;return isTouch?'<div><input id="input" class="faux-input" type="date"/><div>':'<div tabindex="-1"><div  id="input" role="textbox" class="faux-input" contenteditable="true">{{placeholder}}</div></div>'},compile:function(template){return template.prop("type","date"),{pre:function(){},post:function(scope,elem,attr,ctrl){function validFormat(date,format){var dateObject;if(angular.isDefined(date)&&null!==date){if("string"==typeof date){if(10!==date.length)return!1;if(!isTouch&&!/^(?:(?:31(\/)(?:0?[13578]|1[02]))\1|(?:(?:29|30)(\/|)(?:0?[1,3-9]|1[0-2])\2))(?:(?:1[6-9]|[2-9]\d)?\d{2})$|^(?:29(\/)0?2\3(?:(?:(?:1[6-9]|[2-9]\d)?(?:0[48]|[2468][048]|[13579][26])|(?:(?:16|[2468][048]|[3579][26])00))))$|^(?:0?[1-9]|1\d|2[0-8])(\/|)(?:(?:0?[1-9])|(?:1[0-2]))\4(?:(?:1[6-9]|[2-9]\d)?\d{2})$/.test(date))return!1;dateObject=dateCalculator.getDate(date,format)}else{if(!angular.isDate(date))return"function"==typeof date?validFormat(date(),format):!1;dateObject=date}return"Invalid Date"!==dateObject.toString()}}function checkValidity(value){var stringValue;stringValue="Invalid Date"!=value&&angular.isDate(value)?dateCalculator.format(value,dateformat):value,safeApply(scope,function(){angular.isDate(scope.minDate)&&(dateCalculator.dateBeforeOther(value,scope.minDate)?(ngControl.$setValidity("date-min",!0),errorElem.addClass(noErrorClass)):(ngControl.$setValidity("date-min",!1),errorElem.removeClass(noErrorClass))),angular.isDate(scope.maxDate)&&(dateCalculator.dateBeforeOther(scope.maxDate,value)?(ngControl.$setValidity("date-max",!0),errorElem.addClass(noErrorClass)):(ngControl.$setValidity("date-max",!1),errorElem.removeClass(noErrorClass))),validFormat(stringValue,dateformat)?(ngControl.$setValidity("date",!0),errorElem.addClass(noErrorClass),isRequired&&(ngControl.$setValidity("required",!0),errorElem.addClass(noErrorClass))):stringValue!==config.placeholder&&null!==stringValue?(ngControl.$setValidity("date",!1),ngControl.$setValidity("date-min",!0),ngControl.$setValidity("date-max",!0),errorElem.removeClass(noErrorClass),isRequired&&ngControl.$setValidity("required",!0)):(ngControl.$setValidity("date",!0),ngControl.$setValidity("date-min",!0),ngControl.$setValidity("date-max",!0),errorElem.addClass(noErrorClass),isRequired&&(ngControl.$setValidity("required",!1),errorElem.removeClass(noErrorClass)))})}var dateformat,isDateSupported=function(){var i=document.createElement("input");return i.setAttribute("type","date"),"text"!==i.type},isNative=/(ip(a|o)d|iphone|android)/gi.test($window.navigator.userAgent),isTouch="createTouch"in $window.document&&isNative&&isDateSupported(),config={format:"00/00/0000",placeholder:"dd/mm/jjjj"};dateformat=isTouch?"yyyy-mm-dd":"dd/mm/yyyy";var element=elem.find("#input"),ngControl=ctrl[1],controller=ctrl[0],form=ctrl[2],prefix="";angular.isDefined(attr.validName)?setTimeout(function(){form&&attr.name&&"string"==typeof attr.name&&""!==attr.name&&safeApply(scope,function(){prefix=attr.validName,form.$removeControl(ngControl),ngControl.$name=prefix+attr.name,form.$addControl(ngControl)})},1):setTimeout(function(){safeApply(scope,function(){form&&form.$addControl(ngControl)})},1);var isRequired=function(){return attr.required||attr.require?!0:!1}(),noErrorClass="hide-error",errorElem=$(elem.find(".faux-input")[0]),myWatch=0;scope.$watch("$parent."+attr.ngModel,function(newVal,oldval){if(0===myWatch){if(!isTouch||isTouch&&""!==newVal)if("Invalid Date"!=newVal&&angular.isDate(newVal)){var date=dateCalculator.format(newVal,dateformat);controller.setValue(date,null,isTouch),checkValidity(newVal)}else controller.setValue(null,null,isTouch);else controller.setValue("",null,isTouch);checkValidity(newVal)}else myWatch=0},!0),controller.init(element,config,form,ngControl),ngControl.$parsers.unshift(function(value){return isTouch&&""===value&&(value=element.val()),null===value||""===value?value:"string"==typeof value?(controller.setValue(value,null,isTouch),dateCalculator.getDate(value,dateformat)):null}),element.unbind("input").unbind("change"),element.on("blur",function(){safeApply(scope,function(){var value;if(value=isTouch?element.val():controller.getValue(),value===config.placeholder)checkValidity(value),ngControl.$setViewValue(null);else{var date=dateCalculator.getDate(value,dateformat);checkValidity(null===date?value:date),ngControl.$setViewValue(value),ngControl.$setDirty(),ngControl.$render()}var date=$(elem.html()).contents().contents().unwrap()[0].wholeText;validFormat(date,dateformat)||(myWatch=1,controller.setValue(date))})})}}}}}])}();
//# sourceMappingURL=tink-helper-format-angular.min.map